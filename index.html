<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIB34D - Professional 4D Music Video Choreographer</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
            color: #0ff;
            overflow: hidden;
        }

        #mainCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: linear-gradient(180deg, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.85) 100%);
            border-bottom: 2px solid #0ff;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 255, 255, 0.2);
        }

        .logo {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: 2px;
            text-shadow: 0 0 20px #0ff, 0 0 40px #0ff;
            background: linear-gradient(135deg, #0ff 0%, #00ffaa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .system-buttons {
            display: flex;
            gap: 12px;
        }

        .system-btn {
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid #0ff;
            color: #0ff;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .system-btn:hover {
            background: rgba(0, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 255, 0.4);
        }

        .system-btn.active {
            background: linear-gradient(135deg, #0ff 0%, #00ffaa 100%);
            color: #000;
            box-shadow: 0 4px 20px rgba(0, 255, 255, 0.6);
        }

        /* Controls Panel */
        .controls-panel {
            position: fixed;
            right: 20px;
            top: 90px;
            width: 340px;
            max-height: calc(100vh - 180px);
            background: linear-gradient(180deg, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.9) 100%);
            border: 2px solid #0ff;
            border-radius: 12px;
            padding: 25px;
            overflow-y: auto;
            z-index: 999;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(0, 255, 255, 0.3);
        }

        .controls-panel::-webkit-scrollbar {
            width: 8px;
        }

        .controls-panel::-webkit-scrollbar-track {
            background: rgba(0, 255, 255, 0.1);
            border-radius: 4px;
        }

        .controls-panel::-webkit-scrollbar-thumb {
            background: #0ff;
            border-radius: 4px;
        }

        .panel-section {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.2);
        }

        .panel-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: #0ff;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        /* Sliders */
        .param-control {
            margin-bottom: 18px;
        }

        .param-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
            color: #00ffaa;
        }

        .param-name {
            font-weight: 600;
        }

        .param-value {
            font-weight: 700;
            color: #0ff;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            background: rgba(0, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #0ff 0%, #00ffaa 100%);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.6);
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.8);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #0ff 0%, #00ffaa 100%);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.6);
        }

        /* Buttons */
        .btn {
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid #0ff;
            color: #0ff;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s;
            margin: 4px;
        }

        .btn:hover {
            background: rgba(0, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 255, 0.4);
        }

        .btn-primary {
            background: linear-gradient(135deg, #0ff 0%, #00ffaa 100%);
            color: #000;
            border-color: #0ff;
        }

        .btn-primary:hover {
            box-shadow: 0 4px 20px rgba(0, 255, 255, 0.6);
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0;
            margin: -4px;
        }

        /* File Input */
        input[type="file"] {
            display: none;
        }

        .file-label {
            display: block;
            background: rgba(0, 255, 255, 0.1);
            border: 2px dashed #0ff;
            color: #0ff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 13px;
        }

        .file-label:hover {
            background: rgba(0, 255, 255, 0.2);
            border-color: #00ffaa;
        }

        /* Audio Controls */
        .audio-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .play-btn {
            width: 100%;
            background: linear-gradient(135deg, #0ff 0%, #00ffaa 100%);
            color: #000;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            transition: all 0.3s;
        }

        .play-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(0, 255, 255, 0.6);
        }

        /* Status Bar */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(0deg, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.85) 100%);
            border-top: 2px solid #0ff;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            padding: 0 30px;
            z-index: 998;
            box-shadow: 0 -4px 20px rgba(0, 255, 255, 0.2);
        }

        .status-info {
            display: flex;
            gap: 30px;
            align-items: center;
            flex: 1;
        }

        .status-item {
            font-size: 13px;
            font-weight: 600;
        }

        .status-label {
            color: #00ffaa;
            margin-right: 8px;
        }

        .status-value {
            color: #0ff;
            font-weight: 700;
        }

        /* Audio Visualizer Bars */
        .audio-viz {
            display: flex;
            gap: 6px;
            align-items: flex-end;
            height: 30px;
        }

        .audio-bar {
            width: 8px;
            background: linear-gradient(0deg, #0ff 0%, #00ffaa 100%);
            border-radius: 4px 4px 0 0;
            transition: height 0.1s ease-out;
            height: 0%;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.6);
        }

        /* Loading Spinner */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10000;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(0, 255, 255, 0.2);
            border-top: 4px solid #0ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 700;
            color: #0ff;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
        }

        .hidden {
            display: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .controls-panel {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
            }

            .logo {
                font-size: 20px;
            }

            .system-btn {
                padding: 8px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Initializing VIB34D...</div>
    </div>

    <!-- Main Canvas -->
    <canvas id="mainCanvas"></canvas>

    <!-- Header -->
    <div class="header">
        <div class="logo">VIB34D</div>
        <div class="system-buttons">
            <button class="system-btn active" data-system="faceted">🔷 Faceted</button>
            <button class="system-btn" data-system="quantum">🌌 Quantum</button>
            <button class="system-btn" data-system="holographic">✨ Holographic</button>
            <button class="system-btn" data-system="polychora">🔮 Polychora</button>
        </div>
    </div>

    <!-- Controls Panel -->
    <div class="controls-panel">
        <!-- Audio Section -->
        <div class="panel-section">
            <div class="section-title">🎵 Audio</div>
            <input type="file" id="audioFile" accept="audio/*">
            <label for="audioFile" class="file-label" id="fileLabel">
                📁 Choose Audio File
            </label>
            <div class="audio-controls">
                <button class="play-btn" id="playBtn" disabled>▶️ Play</button>
            </div>
        </div>

        <!-- Parameters -->
        <div class="panel-section">
            <div class="section-title">🎛️ Parameters</div>

            <div class="param-control">
                <div class="param-label">
                    <span class="param-name">4D Rotation XW</span>
                    <span class="param-value" id="rot4dXWVal">0.00</span>
                </div>
                <input type="range" id="rot4dXW" min="-2" max="2" step="0.01" value="0">
            </div>

            <div class="param-control">
                <div class="param-label">
                    <span class="param-name">4D Rotation YW</span>
                    <span class="param-value" id="rot4dYWVal">0.00</span>
                </div>
                <input type="range" id="rot4dYW" min="-2" max="2" step="0.01" value="0">
            </div>

            <div class="param-control">
                <div class="param-label">
                    <span class="param-name">4D Rotation ZW</span>
                    <span class="param-value" id="rot4dZWVal">0.00</span>
                </div>
                <input type="range" id="rot4dZW" min="-2" max="2" step="0.01" value="0">
            </div>

            <div class="param-control">
                <div class="param-label">
                    <span class="param-name">Grid Density</span>
                    <span class="param-value" id="gridDensityVal">50</span>
                </div>
                <input type="range" id="gridDensity" min="4" max="100" step="1" value="50">
            </div>

            <div class="param-control">
                <div class="param-label">
                    <span class="param-name">Speed</span>
                    <span class="param-value" id="speedVal">1.0</span>
                </div>
                <input type="range" id="speed" min="0.1" max="3" step="0.1" value="1">
            </div>

            <div class="param-control">
                <div class="param-label">
                    <span class="param-name">Hue</span>
                    <span class="param-value" id="hueVal">200</span>
                </div>
                <input type="range" id="hue" min="0" max="360" step="1" value="200">
            </div>

            <div class="param-control">
                <div class="param-label">
                    <span class="param-name">Geometry Type</span>
                    <span class="param-value" id="geometryVal">0</span>
                </div>
                <input type="range" id="geometry" min="0" max="7" step="1" value="0">
            </div>

            <div class="param-control">
                <div class="param-label">
                    <span class="param-name">Morph Factor</span>
                    <span class="param-value" id="morphFactorVal">1.0</span>
                </div>
                <input type="range" id="morphFactor" min="0" max="2" step="0.1" value="1.0">
            </div>

            <div class="param-control">
                <div class="param-label">
                    <span class="param-name">Chaos</span>
                    <span class="param-value" id="chaosVal">0.2</span>
                </div>
                <input type="range" id="chaos" min="0" max="1" step="0.05" value="0.2">
            </div>

            <div class="param-control">
                <div class="param-label">
                    <span class="param-name">Intensity</span>
                    <span class="param-value" id="intensityVal">0.5</span>
                </div>
                <input type="range" id="intensity" min="0" max="1" step="0.05" value="0.5">
            </div>

            <div class="param-control">
                <div class="param-label">
                    <span class="param-name">Saturation</span>
                    <span class="param-value" id="saturationVal">0.8</span>
                </div>
                <input type="range" id="saturation" min="0" max="1" step="0.05" value="0.8">
            </div>

            <div class="param-control">
                <div class="param-label">
                    <span class="param-name">Dimension</span>
                    <span class="param-value" id="dimensionVal">4.0</span>
                </div>
                <input type="range" id="dimension" min="3" max="5" step="0.1" value="4.0">
            </div>
        </div>

        <!-- Audio Reactivity -->
        <div class="panel-section">
            <div class="section-title">🎚️ Audio Reactivity</div>
            <div class="param-control">
                <div class="param-label">
                    <span class="param-name">Amount</span>
                    <span class="param-value" id="reactivityVal">0.7</span>
                </div>
                <input type="range" id="reactivity" min="0" max="1" step="0.1" value="0.7">
            </div>
        </div>

        <!-- Controls -->
        <div class="panel-section">
            <div class="section-title">🎮 Controls</div>
            <div class="btn-group">
                <button class="btn btn-primary" id="randomizeBtn">🎲 Randomize</button>
                <button class="btn" id="resetBtn">🔄 Reset</button>
                <button class="btn" id="galleryBtn">🎨 Presets</button>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-info">
            <div class="status-item">
                <span class="status-label">System:</span>
                <span class="status-value" id="systemStatus">Faceted</span>
            </div>
            <div class="status-item">
                <span class="status-label">Audio:</span>
                <span class="status-value" id="audioStatus">No audio</span>
            </div>
            <div class="status-item">
                <span class="status-label">FPS:</span>
                <span class="status-value" id="fpsStatus">60</span>
            </div>
        </div>
        <div class="audio-viz" id="audioViz">
            <div class="audio-bar"></div>
            <div class="audio-bar"></div>
            <div class="audio-bar"></div>
            <div class="audio-bar"></div>
            <div class="audio-bar"></div>
            <div class="audio-bar"></div>
            <div class="audio-bar"></div>
        </div>
    </div>

    <script type="module">
        import { SystemRegistry } from './src/systems/shared/SystemRegistry.js?v=20251009-4';
        import { FacetedSystem } from './src/systems/faceted/FacetedSystem.js?v=20251009-4';
        import { QuantumSystem } from './src/systems/quantum/QuantumSystem.js?v=20251009-4';
        import { HolographicSystem } from './src/systems/holographic/HolographicSystem.js?v=20251009-4';
        import { PolychoraSystem } from './src/systems/polychora/PolychoraSystem.js?v=20251009-4';
        import { AudioAnalyzer } from './src/audio/AudioAnalyzer.js?v=20251009-4';
        import { GalleryManager } from './src/export/GalleryManager.js?v=20251009-4';

        // Initialize
        const registry = new SystemRegistry();
        const canvas = document.getElementById('mainCanvas');
        const loading = document.getElementById('loading');

        let galleryManager = null;
        let audioContext = null;
        let audioSource = null;
        let audioAnalyzer = null;
        let isPlaying = false;

        registry.setCanvas(canvas);

        // System configs
        const systemConfigs = {
            faceted: { canvasId: 'mainCanvas', role: 'content', reactivity: 1.0, variant: 0 },
            quantum: { canvasId: 'mainCanvas', role: 'content', reactivity: 1.0, variant: 0 },
            holographic: { canvasId: 'mainCanvas', role: 'content', reactivity: 1.0, variant: 0 },
            polychora: { canvasId: 'mainCanvas', role: 'content', reactivity: 1.0, variant: 0 }
        };

        // Register systems
        registry.register('faceted', FacetedSystem, systemConfigs.faceted);
        registry.register('quantum', QuantumSystem, systemConfigs.quantum);
        registry.register('holographic', HolographicSystem, systemConfigs.holographic);
        registry.register('polychora', PolychoraSystem, systemConfigs.polychora);

        // Initialize
        async function init() {
            try {
                await registry.switchTo('faceted');
                loading.classList.add('hidden');
                console.log('✅ VIB34D Initialized');
            } catch (err) {
                console.error('❌ Error initializing:', err);
                loading.querySelector('.loading-text').textContent = 'Error: ' + err.message;
            }
        }

        init();

        // System switching
        document.querySelectorAll('.system-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const system = btn.dataset.system;

                loading.classList.remove('hidden');
                loading.querySelector('.loading-text').textContent = `Loading ${system}...`;

                try {
                    await registry.switchTo(system);

                    document.querySelectorAll('.system-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    document.getElementById('systemStatus').textContent =
                        system.charAt(0).toUpperCase() + system.slice(1);

                    loading.classList.add('hidden');
                } catch (err) {
                    console.error('Error switching system:', err);
                    loading.querySelector('.loading-text').textContent = 'Error: ' + err.message;
                }
            });
        });

        // Parameters
        const params = ['rot4dXW', 'rot4dYW', 'rot4dZW', 'gridDensity', 'speed', 'hue', 'geometry', 'morphFactor', 'chaos', 'intensity', 'saturation', 'dimension'];
        params.forEach(param => {
            const slider = document.getElementById(param);
            const display = document.getElementById(param + 'Val');

            slider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                let decimals = 1;
                if (param === 'gridDensity' || param === 'geometry' || param === 'hue') decimals = 0;
                else if (param.includes('rot') || param === 'dimension') decimals = 2;
                display.textContent = value.toFixed(decimals);
                registry.updateParameter(param, value);
            });
        });

        // Reactivity
        document.getElementById('reactivity').addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            document.getElementById('reactivityVal').textContent = value.toFixed(1);
            registry.setAudioReactivity(value);
        });

        // Controls
        document.getElementById('randomizeBtn').addEventListener('click', () => {
            params.forEach(param => {
                const slider = document.getElementById(param);
                const min = parseFloat(slider.min);
                const max = parseFloat(slider.max);
                const value = Math.random() * (max - min) + min;
                slider.value = value;
                slider.dispatchEvent(new Event('input'));
            });
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            document.getElementById('rot4dXW').value = 0;
            document.getElementById('rot4dYW').value = 0;
            document.getElementById('rot4dZW').value = 0;
            document.getElementById('gridDensity').value = 50;
            document.getElementById('speed').value = 1;
            document.getElementById('hue').value = 200;
            document.getElementById('reactivity').value = 0.7;

            params.forEach(param => {
                document.getElementById(param).dispatchEvent(new Event('input'));
            });
            document.getElementById('reactivity').dispatchEvent(new Event('input'));
        });

        // Gallery
        document.getElementById('galleryBtn').addEventListener('click', async () => {
            if (!galleryManager) {
                const { GalleryManager } = await import('./src/export/GalleryManager.js');
                galleryManager = new GalleryManager(registry);
            }

            const presets = galleryManager.getAllPresets();
            const names = Object.keys(presets);

            let msg = '🎨 Available Presets:\n\n';
            names.forEach((name, i) => {
                msg += `${i + 1}. ${name}\n`;
            });
            msg += '\nEnter number:';

            const choice = prompt(msg);
            if (choice) {
                const index = parseInt(choice) - 1;
                if (names[index]) {
                    await galleryManager.loadPreset(names[index]);
                }
            }
        });

        // Audio
        document.getElementById('audioFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                const arrayBuffer = await file.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

                if (audioSource) {
                    audioSource.stop();
                }

                audioSource = audioContext.createBufferSource();
                audioSource.buffer = audioBuffer;

                const analyserNode = audioContext.createAnalyser();
                analyserNode.fftSize = 2048;

                audioSource.connect(analyserNode);
                analyserNode.connect(audioContext.destination);

                audioAnalyzer = new AudioAnalyzer(analyserNode);
                registry.setAudioAnalyzer(audioAnalyzer);

                document.getElementById('fileLabel').textContent = `📁 ${file.name}`;
                document.getElementById('audioStatus').textContent = file.name;
                document.getElementById('playBtn').disabled = false;
                isPlaying = false;
                document.getElementById('playBtn').textContent = '▶️ Play';

            } catch (err) {
                console.error('Audio load error:', err);
                alert('Error loading audio: ' + err.message);
            }
        });

        document.getElementById('playBtn').addEventListener('click', () => {
            if (!audioSource) return;

            if (!isPlaying) {
                audioSource.start(0);
                isPlaying = true;
                document.getElementById('playBtn').textContent = '⏸️ Pause';

                // Visualize audio and set global reactive data
                setInterval(() => {
                    if (!audioAnalyzer) return;
                    const data = audioAnalyzer.analyze();
                    const bars = document.querySelectorAll('.audio-bar');
                    const bandNames = ['subBass', 'bass', 'lowMid', 'mid', 'highMid', 'high', 'air'];

                    bars.forEach((bar, i) => {
                        const value = data.bands[bandNames[i]]?.value || 0;
                        bar.style.height = (value * 100) + '%';
                    });

                    // CRITICAL: Set global audio reactive data for visualizers
                    window.audioEnabled = true;
                    window.audioReactive = {
                        bass: data.bands.bass?.value || 0,
                        mid: data.bands.mid?.value || 0,
                        high: data.bands.high?.value || 0,
                        energy: data.rms || 0
                    };
                }, 50);
            }
        });

        // FPS Counter
        let lastTime = performance.now();
        let frames = 0;

        function updateFPS() {
            frames++;
            const now = performance.now();
            if (now - lastTime >= 1000) {
                document.getElementById('fpsStatus').textContent = frames;
                frames = 0;
                lastTime = now;
            }
            requestAnimationFrame(updateFPS);
        }

        updateFPS();

        console.log('🎨 VIB34D - Professional 4D Music Video Choreographer');
        console.log('✨ A Paul Phillips Manifestation');
    </script>
</body>
</html>
